<!doctype html>
button.on{background:#2e8540}
canvas{width:100%;height:200px;}
@keyframes flash { from{opacity:1} to{opacity:.2} }
</style>
<body>
<header>
<div>BOAT DASH</div>
<div id="badges">
<span class="badge" id="b-ap">AP up</span>
<span class="badge" id="b-sta">STA–</span>
<span class="badge" id="b-ntp">NTP–</span>
<span class="badge" id="b-gps">GPS–</span>
<span class="badge" id="ovr" style="display:none;background:#7a1a1a">OVER TEMP</span>
</div>
</header>


<div class="grid">
<div class="card"><div class="big" id="rpm">—</div><div class="label">RPM</div></div>
<div class="card"><div class="big" id="batt">—</div><div class="label">Battery (V)</div></div>
<div class="card"><div class="big" id="fuel">—</div><div class="label">Fuel (%)</div></div>


<div class="card" style="grid-column:1/-1">
<div class="label" style="margin-bottom:8px">Temps — Banks 1‑3 (°F)</div>
<canvas id="tempGraph" height="200"></canvas>
<div style="display:flex;gap:10px;margin-top:6px;font-size:.9rem;color:#9fb1c1">
<span>■ Bank1</span><span>■ Bank2</span><span>■ Bank3</span>
</div>
</div>


<div class="card">
<div class="label" style="margin-bottom:8px">Relays</div>
<div class="relay">
<button id="rNav">Nav</button>
<button id="rAll">All‑around</button>
<button id="rSpot">Spot</button>
</div>
</div>
</div>


<script>
const $ = id => document.getElementById(id);
// Small EKG‑style temp graph
const cfg={hz:10, secs:30, yMin:32, yMax:250, warn:203, over:212};
const N=cfg.hz*cfg.secs; const t1=new Float32Array(N).fill(NaN), t2=new Float32Array(N).fill(NaN), t3=new Float32Array(N).fill(NaN);
let idx=0, filled=false, max1=0,max2=0,max3=0;
const c=$("tempGraph"); const ctx=c.getContext('2d');
function resize(){ c.width=c.clientWidth*devicePixelRatio; c.height=200*devicePixelRatio; }
resize(); addEventListener('resize',resize);
function plot(){
const w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
ctx.strokeStyle='#26313a'; ctx.lineWidth=1; ctx.beginPath();
for(let y=cfg.yMin;y<=cfg.yMax;y+=20){const py=h-((y-cfg.yMin)/(cfg.yMax-cfg.yMin))*h; ctx.moveTo(0,py); ctx.lineTo(w,py);} ctx.stroke();
function draw(arr, color){ ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
const len=filled?N:idx; const start=filled?idx:0; const total=filled?N:len; let first=true;
for(let i=0;i<total;i++){ const j=(start+i)%N; const v=arr[j]; if(!Number.isFinite(v)) continue;
const x=i/(N-1)*w; const y=h-((v-cfg.yMin)/(cfg.yMax-cfg.yMin))*h;
if(first){ctx.moveTo(x,y); first=false;} else ctx.lineTo(x,y);
} ctx.stroke(); }
draw(t1,'#88b7ff'); draw(t2,'#6ee7b7'); draw(t3,'#fca5a5');
const anyOver=(max1>=cfg.over)||(max2>=cfg.over)||(max3>=cfg.over);
$('ovr').style.display= anyOver ? 'inline-block' : 'none';
$('ovr').style.animation = anyOver ? 'flash .6s steps(2,end) infinite' : 'none';
}
setInterval(plot, 1000/15);


// Relay buttons
let relays={nav:false,all:false,spot:false};
function syncRelays(){ $('rNav').classList.toggle('on', relays.nav); $('rAll').classList.toggle('on', relays.all); $('rSpot').classList.toggle('on', relays.spot); }
['rNav','rAll','rSpot'].forEach(id=>{
$(id).onclick=async()=>{ const key=id==='rNav'?'nav':id==='rAll'?'all':'spot'; const body={}; body[key]=!relays[key];
const res=await fetch('/api/relays',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
if(res.ok){ relays=await res.json(); syncRelays(); }
};
});


// WebSocket stream
const ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
ws.onmessage = ev => {
try{
const d = JSON.parse(ev.data);
if(Number.isFinite(d.rpm)) $('rpm').textContent = Math.round(d.rpm);
if(Number.isFinite(d.battV))$('batt').textContent = d.battV.toFixed(2);
if(Number.isFinite(d.fuel)) $('fuel').textContent = d.fuel.toFixed(1);
const b1=d.tempB1, b2=d.tempB2, b3=d.tempB3;
if(Number.isFinite(b1)){ t1[idx]=b1; if(b1>max1) max1=b1; }
if(Number.isFinite(b2)){ t2[idx]=b2; if(b2>max2) max2=b2; }
if(Number.isFinite(b3)){ t3[idx]=b3; if(b3>max3) max3=b3; }
idx=(idx+1)%N; if(idx===0) filled=true;
if(d.relays){ relays=d.relays; syncRelays(); }
$('b-sta').textContent = d.net?.sta ? 'STA up' : 'STA–';
$('b-ntp').textContent = d.net?.ntp ? 'NTP✓' : 'NTP–';
$('b-gps').textContent = d.net?.gps ? 'GPS✓' : 'GPS–';
}catch(e){}
};
</script>
</body>
</html>